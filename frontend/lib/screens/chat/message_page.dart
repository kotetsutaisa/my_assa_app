import 'dart:convert';

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:frontend/models/conversation_model.dart';
import 'package:frontend/models/message_model.dart';
import 'package:frontend/providers/conversation_list_provider.dart';
import 'package:frontend/providers/message_provider.dart';
import 'package:frontend/providers/user_provider.dart';
import 'package:frontend/screens/chat/group_settings_page.dart';
import 'package:frontend/utils/constants.dart';
import 'package:frontend/utils/token_manager.dart';
import 'package:frontend/widgets/chat_header.dart';
import 'package:frontend/widgets/chat_input_field.dart';
import 'package:intl/intl.dart';
import 'package:web_socket_channel/web_socket_channel.dart';
import 'package:frontend/exceptions/message_extensions.dart';


class MessagePage extends ConsumerStatefulWidget {
  final ConversationModel conversation;

  const MessagePage({Key? key, required this.conversation}) : super(key: key);

  @override
  ConsumerState<MessagePage> createState() => _MessagePageState();
}

class _MessagePageState extends ConsumerState<MessagePage> {
  final ScrollController _scrollController = ScrollController();
  late WebSocketChannel _channel;

  @override
  void initState() {
    super.initState();

    _connectWebSocket();
  }

  Future<void> _connectWebSocket() async {
    final roomId = widget.conversation.id;
    final token = await getAccessToken(); // ‚Üê JWT„Éà„Éº„ÇØ„É≥ÂèñÂæó

    final uri = Uri.parse('$wsApiBaseUrl/ws/chat/$roomId/?token=$token');

    _channel = WebSocketChannel.connect(uri);

    _channel.stream.listen((event) {
      print('üì• WebSocket„É°„ÉÉ„Çª„Éº„Ç∏Âèó‰ø°: $event');

      final data = jsonDecode(event);

      // --- Êó¢Ë™≠ÈÄöÁü•„ÅÆÂá¶ÁêÜ„ÇíËøΩÂä† ---
      if (data['type'] == 'read') {
        final messageId = data['message_id'];

        ref
          .read(messageListProvider(widget.conversation.id).notifier)
          .markMessageAsRead(messageId);

        return;
      }

      // --- ÈÄöÂ∏∏„ÅÆÊñ∞ÁùÄ„É°„ÉÉ„Çª„Éº„Ç∏Âá¶ÁêÜ ---
      final message = MessageModel.fromJson(data);

      ref
        .read(messageListProvider(widget.conversation.id).notifier)
        .addReceivedMessage(message);
    },
    onError: (error) {
      print('‚ùå WebSocket„Ç®„É©„Éº: $error');
    },
    onDone: () {
      print('üîå WebSocketÊé•Á∂öÁµÇ‰∫Ü');
    });

    print('‚úÖ WebSocket„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü');
  }


  @override
  void dispose() {
    _channel.sink.close();
    _scrollController.dispose();
    super.dispose();
  }

  bool isMyMessage(dynamic senderId) {
    final myId = ref.read(userProvider)?.id;
    return senderId.toString() == myId.toString();
  }

  void _scrollToBottom() {
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (!_scrollController.hasClients) return;

      final maxScroll = _scrollController.position.maxScrollExtent;
      if (maxScroll == 0) return;

      _scrollController.jumpTo(maxScroll); // ‚Üê „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Å™„Åó„Åß‰∏ÄÁû¨„Åß„Çπ„ÇØ„É≠„Éº„É´
    });
  }


  @override
  Widget build(BuildContext context) {
    final messageListAsync = ref.watch(messageListProvider(widget.conversation.id));
    final partnerUser = widget.conversation.partner;

    // üü° „Åì„Åì„Åß„Ç≠„Éº„Éú„Éº„Éâ„ÅÆÈñãÈñâÁä∂ÊÖã„ÇíÂèñÂæó
    final keyboardHeight = MediaQuery.of(context).viewInsets.bottom;

    // üü¢ „Ç≠„Éº„Éú„Éº„Éâ„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Åü„Çâ„Çπ„ÇØ„É≠„Éº„É´
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (keyboardHeight > 0) {
        _scrollToBottom();
      }
    });

    return Scaffold(
      resizeToAvoidBottomInset: true,
      appBar: ChatHeader(
        username: widget.conversation.isGroup
            ? widget.conversation.title ?? '„Ç∞„É´„Éº„Éó'
            : partnerUser?.username ?? '‰∏çÊòé„Å™„É¶„Éº„Ç∂„Éº',
        userIconUrl: widget.conversation.isGroup
            ? widget.conversation.icon
            : partnerUser?.iconimg,

        // „Ç∞„É´„Éº„Éó„ÅÆ„Å®„Åç„Å†„ÅëÊ≠ØËªä„Ç¢„Ç§„Ç≥„É≥„ÇíÊ∏°„Åô
        trailing: widget.conversation.isGroup
            ? IconButton(
                icon: Icon(Icons.settings, color: Theme.of(context).colorScheme.secondary),
                onPressed: () {
                  Navigator.push(
                    context,
                    MaterialPageRoute(
                      builder: (_) => GroupSettingsPage(conversation: widget.conversation),
                    ),
                  );
                },
              )
            : null,
      ),
      body: GestureDetector(
        behavior: HitTestBehavior.translucent,
        onTap: () => FocusScope.of(context).unfocus(),
        child: Column(
          children: [
            Expanded(
              child: messageListAsync.when(
                loading: () => const Center(child: CircularProgressIndicator()),
                error: (e, _) => Center(child: Text('„Ç®„É©„Éº: $e')),
                data: (messages) {

                  final List<Map<String, dynamic>> decoratedMessages = [];
                    DateTime? lastDate;

                    for (final msg in messages) {
                      final msgDate = DateTime(msg.createdAt.year, msg.createdAt.month, msg.createdAt.day);

                      if (lastDate == null || msgDate != lastDate) {
                        decoratedMessages.add({'type': 'date', 'date': msgDate});
                        lastDate = msgDate;
                      }

                      decoratedMessages.add({'type': 'message', 'message': msg});
                    }

                  _scrollToBottom();
                  return ListView.builder(
                    controller: _scrollController,
                    padding: EdgeInsets.only(
                      left: 16,
                      right: 16,
                      top: 12,
                      // 2. ÂÖ•ÂäõÊ¨Ñ + ‰ΩôÁôΩ„Å∂„Çì‰∏ã„Å´„Çπ„Éö„Éº„Çπ
                      bottom: 12 + MediaQuery.of(context).viewInsets.bottom,
                    ),
                    itemCount: decoratedMessages.length,
                    itemBuilder: (context, index) {

                      final item = decoratedMessages[index];

                      if (item['type'] == 'date') {
                        final date = item['date'] as DateTime;

                        final now = DateTime.now();
                        final today = DateTime(now.year, now.month, now.day);
                        final yesterday = today.subtract(const Duration(days: 1));
                        final msgDate = DateTime(date.year, date.month, date.day);

                        String label;
                        if (msgDate == today) {
                          label = '‰ªäÊó•';
                        } else if (msgDate == yesterday) {
                          label = 'Êò®Êó•';
                        } else {
                          label = DateFormat('MÊúàdÊó• (E)', 'ja').format(msgDate); // ‰æã: 6Êúà2Êó• (Êó•)
                        }

                        return Center(
                          child: Padding(
                            padding: const EdgeInsets.symmetric(vertical: 12),
                            child: Text(
                              label,
                              style: const TextStyle(fontSize: 13, color: Colors.grey),
                            ),
                          ),
                        );
                      }

                      final msg = item['message'] as MessageModel;
                      final isMe = isMyMessage(msg.sender.id);
                      final text = msg.body['text'] ?? '';

                      if (msg.kind == 'system') {
                        // üü° „Ç∑„Çπ„ÉÜ„É†„É°„ÉÉ„Çª„Éº„Ç∏Áî®„ÅÆUI
                        return Center(
                          child: Container(
                            margin: const EdgeInsets.symmetric(vertical: 12),
                            padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                            decoration: BoxDecoration(
                              color: Colors.grey.shade300,
                              borderRadius: BorderRadius.circular(12),
                            ),
                            child: Text(
                              text,
                              style: const TextStyle(
                                fontSize: 13,
                                fontStyle: FontStyle.italic,
                                color: Colors.black54,
                              ),
                            ),
                          ),
                        );
                      }
                      
                      return Container(
                        margin: const EdgeInsets.symmetric(vertical: 6),
                        alignment:
                            isMe ? Alignment.centerRight : Alignment.centerLeft,
                        child: Column(
                          crossAxisAlignment:
                              isMe ? CrossAxisAlignment.end : CrossAxisAlignment.start,
                          children: [
                            Container(
                              padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),
                              constraints: BoxConstraints(
                                maxWidth: MediaQuery.of(context).size.width * 0.7,
                              ),
                              decoration: BoxDecoration(
                                color: isMe ? Colors.blueAccent : Colors.grey.shade300,
                                borderRadius: BorderRadius.only(
                                  topLeft: const Radius.circular(18),
                                  topRight: const Radius.circular(18),
                                  bottomLeft: Radius.circular(isMe ? 18 : 0),
                                  bottomRight: Radius.circular(isMe ? 0 : 18),
                                ),
                              ),
                              child: Text(
                                text,
                                style: TextStyle(
                                  color: isMe ? Colors.white : Colors.black87,
                                  fontSize: 15,
                                ),
                              ),
                            ),
                            const SizedBox(height: 4),
                            Text(
                              DateFormat('HH:mm').format(msg.createdAt),
                              style: const TextStyle(fontSize: 11, color: Colors.grey),
                            ),

                            if (isMe)
                              widget.conversation.isGroup
                                ? (msg.readUsers.isNotEmpty
                                  ? Text(
                                      '${msg.readUsers.length}Êó¢Ë™≠',
                                      style: const TextStyle(fontSize: 11, color: Colors.green),
                                    )
                                  : const SizedBox.shrink())

                                : Text(
                                    msg.isRead ? 'Êó¢Ë™≠' : 'Êú™Ë™≠',
                                    style: TextStyle(
                                      fontSize: 11,
                                      color: msg.isRead ? Colors.green : Colors.grey,
                                    ),
                                  ),
                          ],
                        ),
                      );
                    },
                  );
                },
              ),
            ),

            // ÂÖ•ÂäõÊ¨ÑÔºàchat_input_field.dart„Çí‰Ωø„ÅÜÔºâ
            SafeArea(
              minimum: const EdgeInsets.symmetric(horizontal: 8, vertical: 6),
              child: ChatInputField(
                onSend: (text) async {
                  if (text.isEmpty) return;
                  print('‚úÖ „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°: $text');
                  // TODO: kind„ÅØÂãïÁöÑ„Å´‰øÆÊ≠£
                  
                  final notifier = ref.read(messageListProvider(widget.conversation.id).notifier);

                  // „É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åó„ÄÅ„É¨„Çπ„Éù„É≥„ÇπÔºà‰ΩúÊàê„Åï„Çå„ÅüMessageModelÔºâ„ÇíÂèñÂæó
                  final newMessage = await notifier.addMessage(
                    kind: 'text',
                    bodyText: text,
                  );

                  // ‚úÖ ‰ºöË©±‰∏ÄË¶ß„ÅÆÁä∂ÊÖãÔºàlastMessageÔºâ„ÇíÊõ¥Êñ∞
                  ref.read(conversationListProvider.notifier).updateLastMessage(
                    conversationId: widget.conversation.id,
                    newMessage: newMessage.toLastMessage(), // ‚Üê MessageModel ‚Üí LastMessage „Å´Â§âÊèõ„Åô„Çã„É°„ÇΩ„ÉÉ„Éâ„ÅåÂøÖË¶Å
                  );

                  _scrollToBottom();
                },
              ),
            ),
          ],
        ),
      ),
    );
  }
}



